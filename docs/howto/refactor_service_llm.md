# Как перенести существующий сервис с старого бека на новый

1. Анализ
- Проанализируй код в директориях {html, www}/company/payorder
  а также весь код, от которого он зависит (include / require / use), включая транзитивные зависимости
- Проведи системный анализ кода - выдели список SQL запросов, с подробным объяснением каждого запроса. При наличии процедур - дай описание их работы, используя cp-mcp. Создай ERM диаграммы. Создай диаграммы последовательностей для юзкейсов (порядок действий пользователя для решения конкретных задач). Все диаграммы должны быть в mermaid формате.
- Получи из истории git список коммитов, которые затрагивали проанализированные файлы. Выведи список задач, которые указаны в этих коммитах.
- Скопируй эту часть кодовой базы в отдельную директорию в www/payorder2. Там же положи readme.md, со всей собранной аналитикой.
2. Рефакторинг (перезагрузка контекста только выделенной частью кода)
- представь список последовательностей http запросов для каждого юзкейса. Напиши на основании этого тест, прогоняющий всё юзкейсы.
- выведи список всех побочных эффектов этого кода - работа с бд, сетью, ФС, кэшом и т.д. Подсвети места, где замокать побочные эффекты будет проще всего.
-  [тут надо проверить тест - только тестовая бд, на каждый юзкейс отдельная транзакция. реальные http запросы выполнять не надо - заполнять и очищать стейт php на каждом "запросе". далее тест блокируется для модификации]
- убедись что тесты выполняются.
- Выяви основные проблемы этого кода. Для каждой проблемы предложи оптимальное решение.
- После подтверждения решения, в цикле выполняй исправления. Каждый раз выполняй тесты чтобы убедится в работоспособности кода.
3. Интеграция (копируем директорию на back2)
- Составь список эндпоинтов по полученым юзкейсам (вида dit.payorder.USECASE).
- По ERM диаграмме создай список Entity. Выдели ключевые и вспомогательные Entity.
- адаптируй все полученные sql запросы в набор Repository (1 ключевая Entity = 1 Repository).
- используй system:make для создания заготовок всех Entity, Repository, Controller
- Остальную часть кода перенеси в UseCase. Выделяй наиболее сложные и обособленные части логики в Services. В Common выноси код, не относящийся к бизнес логике и который можно будет использовать в других сервисах.
- Адаптируй тест на юзкейсы применительно к rpc методам. Убедись, что тест работает корректно.
- Покрой unit тестами UseCase/Entity/Service. Добейся покрытия > 90%