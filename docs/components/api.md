## Описание API кор.портала

Здесь представлено описание апи кор.портала для новой версии бэкенда.  
Для старой версии бэкенда частичное описание можно прочитать
[по этой ссылке](http://192.168.6.29/portal/back/-/wikis/Backend/API)

## Общий формат запросов

Формат запросов и ответов соответствует спецификации [JSON-RPC 2.0](https://www.jsonrpc.org/specification)

В данный момент, апи использует только протокол HTTP в качестве транспорта, но в дальнейшем, 
с некоторыми незначительными ограничениями, может использовать и другие протоколы обмена данными, например WebSocket.  

## HTTP

Все запросы должны выполняться методом **POST** по url **/api/v2/rpc**  
Исключение - запрос методом **GET** по этому url вернет спецификацию апи в одном из следующих форматов:

| URL                          | Формат                                                                                                            |
|------------------------------|-------------------------------------------------------------------------------------------------------------------|
| /api/v2/rpc?specType=openRpc | [OpenRpc](https://spec.open-rpc.org/), используется по умолчанию                                                  |
| /api/v2/rpc?specType=postman | Вернёт [коллекцию запросов для Postman](https://learning.postman.com/collection-format/getting-started/overview/) |
| /api/v2/rpc?specType=jSight  | [jSight](https://jsight.io/docs/api-examples/example08/) (экспериментальная поддержка)                            |

Данные спецификации, в теории, содержат всю необходимую информацию для использования 
методов апи, включая список серверов, структуру ответа, входные параметры, типах данных, примеры использования, текстовые описания и т.д.

## Mocks

Для openRpc в дополнение основной спецификации используются мок-методы.
По умолчанию моки уже включены в спецификацию, отключить их можно параметром запросом url:
/api/v2/rpc?specType=openRpc&includeMocks=false

Моки отличаются от обычных методов по следующим признакам:
- У методов указан тег mock
- Примеры внутри мок метода или внутри реального метода в названии имеют приставку [MOCK]

[Подробнее о моках](./api_mock.md)

## Ошибки

В случае неудачной обработки запроса, бэкендом должен вернуться соответствующий [объект ошибки](https://www.jsonrpc.org/specification#error_object).

HTTP статус следует игнорировать, чтобы не обрабатывать специальным образом [batch запросы](https://www.jsonrpc.org/specification#batch).  
При этом рекомендуется на всякий случай учитывать критичные для фронта HTTP статусы, отличные от 200.

Сообщение об ошибке берётся из обязательного поля `error.message (string)`.  
Опционально, бэк может вернуть поле `error.data.message (string)` с дополнительной информацией для отображения.

| Код | Сообщение ошибки | Контекстное сообщение                        |
|-----|------------------|----------------------------------------------|
| 401 | Не авторизован   | клиент не передал токен доступа              |
| 403 | Нет прав         | cp_action: accured_kpi.accured_kpi_superboss |
| 404 | Не найдено       | Не найден пользователь с id 777              |

Код носит технический характер и служит только для идентификации ошибки.  
Этот код будет соответствовать одному из 4xx / 5xx статусов HTTP, одной из RPC ошибок (см. спецификацию),
или кастомному коду ошибки который задал разработчик (20ххх для оракла, 6xx доменные, и т.д.) 
Сообщение ошибки содержит заранее известную информацию об ошибке (соответствующую коду).  
Контекстное сообщение даёт дополнительную информацию, полученную в момент ошибки.

Формирование системного сообщения об ошибке:  
- Всегда выводим сообщение из `error.message`  
- При наличии поля `error.data`, выводим дополнительное контекстное сообщение из поля `error.data.message`

Любые дополнительные (несистемные) обработки обговариваются на этапе разработки и могут
использовать дополнительные данные из поля `error.data`.

Полный пример объекта `error.data` (нужно учитывать, что все поля опциональны):

    {
        message: 'Невалидные данные отчёта', // Контекстное сообщение
        code : 40567,                        // Дополнительный код от внутренней системы
        service: 'Oracle',                   // Название внутренней системы 
        skipSystemMessage: true,             // если true, системной сообщение показывать не нужно

        // массив ошибок валидации. Используется в случае ошибки 400 (Bad Request)
        violations: [
            { field: 'name', message: 'Длина не более 100 символов' }
        ]
    }

> **Справочная информация**  
> Все известные коды ошибок можно получить методом `common.dictionary.getErrorCodes`.  
> Там же есть информация по диапазонам кодов ошибок.

## Аутентификация и авторизация

В данный момент, у нового бэкенда нет собственной системы контроля прав, для этого
используется старое апи.

> Есть альтернативный способ передачи токена - в виде куки `token`. Например,
> такой способ более удобен для встраивания картинок с авторизацией (см. [API работы с файлами](./files.md))

Токен доступа нужно получать посредством вызова **/api/v1/login**, полученный 
**result.token** нужно передавать в каждом запросе в заголовке **Authorization**.

    >>> 
    curl 'https://cp.siberianhealth.com/api/v1/login' \
    --data-raw '{"login":"name","password":"***"}'

    <<<
    {
        "result": {
            "token": TOKEN,
            ...
        }
    }

Проверку прав доступа нужно делать через метод **canAccess**

    >>>
    curl 'https://cp.siberianhealth.com/api/v1/rpc' \
    -H 'authorization: TOKEN' \
    --data-raw '{"jsonrpc":"2.0","id":"1234","method":"canAccess","params":{"resource":"kpi","access":"view"}}'

    <<<
    {
        "jsonrpc": "2.0",
        "id": "1234",
        "result": true
    }

## Прочее

Rate Limits: у нас нет явного ограничения на кол-во запросов.

Response time: Время ответа также не регламентировано, мягкое ограничение -
не более 1 секунды в prod окружении (в dev время ответа как правило больше)
