## Исключения

Механизм исключений предназначен для корректной обработки ошибок.

Есть две принципиально отличающихся ситуации:
- штатные ошибки (предусмотренные разработчиком)
- непредвиденные ошибки

Любое брошенное исключение преобразуется в корректный RPC-ответ
на инфраструктурном уровне.

### Штатные ошибки

В большинстве случаев, штатные ошибки хорошо соотносятся с HTTP кодами (4xx ошибки).  
Для них в Symfony предусмотрены стандартные исключения, следует использовать их.
(см. `Symfony\Component\HttpKernel\Exception\HttpException`)

Можно создавать и свои исключения, наследуясь от `App\Domain\Portal\DomainException`.  
Для этого, каждому новому типу исключения нужно добавлять свой код в диапазоне 600-999 в `DomainException`.

Параметром `context` можно добавить контекстные данные ошибки (будут переданы в rpc `error.data`).
Также можно расширить метод `getContext`, добавив в него дополнительную логику.

**Пример**: добавляем исключение "Требуется согласование заявки" с кодом 666,
в контекст добавляем список согласователей.

```php
// DomainException.php
...
    const APPROVAL_REQUIRED = 666;
...

// ApprovalRequiredException.php

class ApprovalRequiredException extends DomainException
{
    public function __construct(string $message = "Требуется согласование заявки", array $context = [])
    {
        parent::__construct($message, DomainException::APPROVAL_REQUIRED, $context);
    }
}

// использование
throw new ApprovalRequiredException(context: ['coordinatorIds' => [71,45,54]]);
```

### Непредвиденные ошибки

Эти ошибки регистрируются в Sentry для последующего исправления.  
На фронт попадает сообщение "Внутренняя ошибка сервера".

### Ошибки БД

Существенная часть ошибок происходит на уровне взаимодействия в БД.
Эти ошибки также сводятся к штатным ошибкам (`DatabaseRaisedApplicationException`)
и к непредвиденным ошибкам (`DatabaseException`). Специальным образом их обрабатывать не нужно,
они обрабатываются на инфраструктурном уровне.

### Ошибки в локальном окружении

Локально в `error.data` добавляется поле exception, содержащее всю
стандартную информацию об ошибке (файл, строка, стектрейс).
В Sentry сообщения не отправляются, но должны добавляться в лог ошибок `var/log/dev.log`