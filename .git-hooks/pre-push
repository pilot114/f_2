#!/bin/sh

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

COMMIT_MESSAGE=$(git log -1 --pretty=%B)
PATTERN='^(feat|fix|docs|style|refactor|perf|test)\([A-Z]+-[0-9]+\): .*|^(chore|build|ci|revert).*?: .*|Merge branch.*|Revert.*'

if ! echo "$COMMIT_MESSAGE" | grep -qE "$PATTERN"; then
    echo "${RED}‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∫–æ–º–º–∏—Ç—ã, —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç—É: feat(CP-123): message in English${NC}"
    exit 1
fi

mkdir -p var/lint
START=$(date +%s)

echo "${YELLOW}üîç –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–µ—Ä–µ–¥ push...${NC}"

# –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∏, –ë–ï–ó –∞–≤—Ç–æ—Ñ–∏–∫—Å–æ–≤
(composer rector-lint; echo $? > "var/lint/rector") &
(composer ecs-lint; echo $? > "var/lint/ecs") &
(composer phpstan-lint; echo $? > "var/lint/phpstan") &
(composer test; echo $? > "var/lint/test")
wait

END=$(date +%s)
ALL_DIFF=$(( $END - $START ))

RECTOR_EXIT_CODE=$(cat "var/lint/rector")
ECS_EXIT_CODE=$(cat "var/lint/ecs")
PHPSTAN_EXIT_CODE=$(cat "var/lint/phpstan")
TEST_EXIT_CODE=$(cat "var/lint/test")

rm -rf "./var/lint/"

if [ $RECTOR_EXIT_CODE -ne 0 ] || [ $ECS_EXIT_CODE -ne 0 ] || [ $PHPSTAN_EXIT_CODE -ne 0 ] || [ $TEST_EXIT_CODE -ne 0 ]; then
    echo "${RED}üö´ –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ—à–ª–∏${NC}"
    exit 1
fi

echo "ALL took $ALL_DIFF seconds"
echo "${GREEN}‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!${NC}"
exit 0
